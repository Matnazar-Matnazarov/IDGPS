{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}
{% load humanize %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <!-- Header Section -->
    <div class="mb-8">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
            <h1 class="text-2xl font-bold text-base-content flex items-center gap-2">
                <div class="bg-primary/10 p-2 rounded-lg">
                    <i class="fas fa-calculator text-primary text-xl"></i>
                </div>
                <span>
                    {% if is_detail_view %}
                        {% for item in bugalteriya_data %}
                            {{ item.sotish.mijoz }} - To'lovlar
                        {% endfor %}
                    {% else %}
                        {{ current_year }} yil bugalteriya
                    {% endif %}
                </span>
            </h1>
            <div class="flex gap-2 items-center">
                {% if is_detail_view %}
                    <a href="{% url 'bugalteriya-list' %}" class="btn btn-outline btn-sm">
                        <i class="fas fa-arrow-left"></i>
                        Orqaga
                    </a>
                {% else %}
                    <select id="year-select" name="yil" class="select select-bordered select-sm">
                        {% for yil in years %}
                        <option value="{{ yil }}" {% if yil == current_year %}selected{% endif %}>{{ yil }}</option>
                        {% endfor %}
                    </select>
                {% endif %}
                <button onclick="window.print()" class="btn btn-ghost btn-sm gap-2">
                    <i class="fas fa-print"></i>
                    Chop etish
                </button>
            </div>
        </div>
    </div>

    {% if error_message %}
    <div class="alert alert-error shadow-lg mb-6">
        <div>
            <i class="fas fa-exclamation-circle"></i>
            <span>{{ error_message }}</span>
        </div>
    </div>
    {% endif %}

    <!-- Legend for statuses -->
    <div class="card bg-base-100 shadow-lg mb-6 p-4">
        <div class="flex flex-wrap gap-4 justify-center sm:justify-start">
            <div class="flex items-center gap-2">
                <div class="badge badge-success text-white gap-1">
                    <i class="fas fa-check-circle"></i>
                </div>
                <span class="text-sm">To'langan</span>
            </div>
            <div class="flex items-center gap-2">
                <div class="badge badge-error text-white gap-1">
                    <i class="fas fa-times-circle"></i>
                </div>
                <span class="text-sm">To'lanmagan</span>
            </div>
            <div class="flex items-center gap-2">
                <div class="badge badge-ghost gap-1">
                    <i class="fas fa-circle-notch"></i>
                </div>
                <span class="text-sm">Belgilanmagan</span>
            </div>
            <div class="flex items-center gap-2">
                <div class="badge badge-primary text-white gap-1">
                    <i class="fas fa-plus-circle"></i>
                </div>
                <span class="text-sm">To'lovni tasdiqlash</span>
            </div>
        </div>
    </div>

    <!-- Bugalteriya Table -->
    <div class="card bg-base-100 shadow-lg overflow-x-auto">
        <div class="card-body p-0">
            <div class="overflow-x-auto">
                <table class="table table-zebra w-full">
                    <thead>
                        <tr>
                            <th class="bg-base-200 z-10 sticky left-0">Mijoz</th>
                            <th class="bg-base-200 z-10 sticky left-[120px]">GPS</th>
                            {% for oy in oylar %}
                            <th class="bg-base-200 text-center" colspan="2">{{ oy }}</th>
                            {% endfor %}
                        </tr>
                        <tr>
                            <th colspan="2" class="bg-base-200 z-10 sticky left-0"></th>
                            {% for oy in oylar %}
                            <th class="bg-base-200 text-center text-xs">
                                <div class="flex justify-center items-center gap-1">
                                    <i class="fas fa-user text-primary"></i>
                                    <span>Abonent</span>
                                </div>
                            </th>
                            <th class="bg-base-200 text-center text-xs">
                                <div class="flex justify-center items-center gap-1">
                                    <i class="fas fa-sim-card text-secondary"></i>
                                    <span>SIM</span>
                                </div>
                            </th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in bugalteriya_data %}
                            {% for gps_item in item.gps_data %}
                                <tr class="hover">
                                    {% if forloop.first %}
                                    <td class="font-medium z-10 sticky left-0 bg-base-100" rowspan="{{ item.gps_data|length }}">
                                        <div class="flex items-center gap-2">
                                            <i class="fas fa-user text-primary"></i>
                                            {% if is_detail_view %}
                                                {{ item.sotish.mijoz }}
                                            {% else %}
                                                <a href="{% url 'bugalteriya-detail' item.sotish.id %}" class="link link-hover link-primary">
                                                    {{ item.sotish.mijoz }}
                                                </a>
                                            {% endif %}
                                        </div>
                                    </td>
                                    {% endif %}
                                    <td class="z-10 sticky left-[120px] bg-base-100">
                                        <div class="flex items-center gap-2">
                                            <i class="fas fa-satellite text-secondary"></i>
                                            {{ gps_item.gps.gps_id }}
                                        </div>
                                    </td>
                                    {% for oy in oylar %}
                                    {% with tolov=gps_item.tolovlar|get_item:oy %}
                                    <!-- Abonent to'lovi -->
                                    <td class="text-center">
                                        <button 
                                            data-tolov-id="{{ tolov.abonent.id }}"
                                            data-sotish-id="{{ item.sotish.id }}"
                                            data-gps-id="{{ gps_item.gps.id }}"
                                            data-oy="{{ oy }}"
                                            data-yil="{{ current_year }}"
                                            data-type="abonent"
                                            data-is-superuser="{{ request.user.is_superuser|yesno:'true,false' }}"
                                            class="tolov-btn btn btn-sm btn-circle tooltip"
                                            data-tip="{% if tolov.tolov is None %}To'lovni tasdiqlash{% elif tolov.abonent.status is True %}To'langan{% elif tolov.abonent.status is False %}To'lanmagan{% else %}Belgilanmagan{% endif %}"
                                            aria-label="{% if tolov.tolov is None %}To'lovni tasdiqlash{% elif tolov.abonent.status is True %}To'langan{% elif tolov.abonent.status is False %}To'lanmagan{% else %}Belgilanmagan{% endif %}"
                                            {% if tolov.tolov is None %}
                                                btn-primary text-white
                                            {% elif tolov.abonent.status is True %}
                                                btn-success text-white
                                            {% elif tolov.abonent.status is False %}
                                                btn-error text-white
                                            {% else %}
                                                btn-ghost
                                            {% endif %}">
                                            {% if tolov.tolov is None %}
                                                <i class="fas fa-plus-circle"></i>
                                            {% elif tolov.abonent.status is True %}
                                                <i class="fas fa-check-circle"></i>
                                            {% elif tolov.abonent.status is False %}
                                                <i class="fas fa-times-circle"></i>
                                            {% else %}
                                                <i class="fas fa-circle-notch"></i>
                                            {% endif %}
                                        </button>
                                    </td>
                                    
                                    <!-- SIM karta to'lovi -->
                                    <td class="text-center">
                                        <button 
                                            data-tolov-id="{{ tolov.sim.id }}"
                                            data-sotish-id="{{ item.sotish.id }}"
                                            data-gps-id="{{ gps_item.gps.id }}"
                                            data-oy="{{ oy }}"
                                            data-yil="{{ current_year }}"
                                            data-type="sim"
                                            data-is-superuser="{{ request.user.is_superuser|yesno:'true,false' }}"
                                            class="tolov-btn btn btn-sm btn-circle tooltip"
                                            data-tip="{% if tolov.tolov is None %}To'lovni tasdiqlash{% elif tolov.sim.status is True %}To'langan{% elif tolov.sim.status is False %}To'lanmagan{% else %}Belgilanmagan{% endif %}"
                                            aria-label="{% if tolov.tolov is None %}To'lovni tasdiqlash{% elif tolov.sim.status is True %}To'langan{% elif tolov.sim.status is False %}To'lanmagan{% else %}Belgilanmagan{% endif %}"
                                            {% if tolov.tolov is None %}
                                                btn-primary text-white
                                            {% elif tolov.sim.status is True %}
                                                btn-success text-white
                                            {% elif tolov.sim.status is False %}
                                                btn-error text-white
                                            {% else %}
                                                btn-ghost
                                            {% endif %}">
                                            {% if tolov.tolov is None %}
                                                <i class="fas fa-plus-circle"></i>
                                            {% elif tolov.sim.status is True %}
                                                <i class="fas fa-check-circle"></i>
                                            {% elif tolov.sim.status is False %}
                                                <i class="fas fa-times-circle"></i>
                                            {% else %}
                                                <i class="fas fa-circle-notch"></i>
                                            {% endif %}
                                        </button>
                                    </td>
                                    {% endwith %}
                                    {% endfor %}
                                </tr>
                            {% endfor %}
                        {% empty %}
                        <tr>
                            <td colspan="{{ oylar|length|add:2 }}" class="text-center py-10 text-base-content/70">
                                <div class="flex flex-col items-center justify-center">
                                    <i class="fas fa-folder-open text-3xl mb-2"></i>
                                    <p>Hisobotlar mavjud emas</p>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    {% if is_detail_view %}
    <!-- Client Details -->
    <div class="mt-6 card bg-base-100 shadow-lg">
        <div class="card-body">
            {% for item in bugalteriya_data %}
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <h3 class="text-lg font-medium mb-3">Mijoz ma'lumotlari</h3>
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span class="text-base-content/70">Mijoz:</span>
                            <span class="font-medium">{{ item.sotish.mijoz }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-base-content/70">Telefon:</span>
                            <span class="font-medium">{{ item.sotish.mijoz_tel_raqam }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-base-content/70">Oylik to'lov:</span>
                            <span class="font-medium">{{ item.sotish.abonent_tulov|intcomma }} so'm</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-base-content/70">GPS qurilmalar:</span>
                            <span class="font-medium">{{ item.gps_data|length }} ta</span>
                        </div>
                    </div>
                </div>
                <div>
                    <h3 class="text-lg font-medium mb-3">To'lovlar statistikasi</h3>
                    <div class="space-y-2">
                        {% with total_paid=0 total_unpaid=0 %}
                            {% for gps_item in item.gps_data %}
                                {% for oy, tolov in gps_item.tolovlar.items %}
                                    {% if tolov.abonent.status %}
                                        {% with total_paid=total_paid|add:1 %}{% endwith %}
                                    {% elif tolov.abonent.status == False %}
                                        {% with total_unpaid=total_unpaid|add:1 %}{% endwith %}
                                    {% endif %}
                                {% endfor %}
                            {% endfor %}
                            <div class="flex justify-between">
                                <span class="text-base-content/70">To'langan:</span>
                                <span class="font-medium text-success">{{ total_paid }} ta</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-base-content/70">To'lanmagan:</span>
                                <span class="font-medium text-error">{{ total_unpaid }} ta</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-base-content/70">Jami to'lov:</span>
                                <span class="font-medium">{{ item.sotish.abonent_tulov|intcomma }} so'm (1 oylik)</span>
                            </div>
                        {% endwith %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% else %}
    <!-- Summary Section -->
    <div class="mt-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="card bg-base-100 shadow-lg">
            <div class="card-body p-4">
                <div class="flex items-center gap-3">
                    <div class="bg-success/10 p-3 rounded-full">
                        <i class="fas fa-check-circle text-success text-lg"></i>
                    </div>
                    <div>
                        <h3 class="text-sm font-medium text-base-content/70">To'langan abonentlar</h3>
                        <p class="text-xl font-bold text-success">0</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="card bg-base-100 shadow-lg">
            <div class="card-body p-4">
                <div class="flex items-center gap-3">
                    <div class="bg-error/10 p-3 rounded-full">
                        <i class="fas fa-times-circle text-error text-lg"></i>
                    </div>
                    <div>
                        <h3 class="text-sm font-medium text-base-content/70">To'lanmagan abonentlar</h3>
                        <p class="text-xl font-bold text-error">0</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="card bg-base-100 shadow-lg">
            <div class="card-body p-4">
                <div class="flex items-center gap-3">
                    <div class="bg-primary/10 p-3 rounded-full">
                        <i class="fas fa-user text-primary text-lg"></i>
                    </div>
                    <div>
                        <h3 class="text-sm font-medium text-base-content/70">Mijozlar soni</h3>
                        <p class="text-xl font-bold text-base-content">{{ bugalteriya_data|length }}</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="card bg-base-100 shadow-lg">
            <div class="card-body p-4">
                <div class="flex items-center gap-3">
                    <div class="bg-secondary/10 p-3 rounded-full">
                        <i class="fas fa-satellite text-secondary text-lg"></i>
                    </div>
                    <div>
                        <h3 class="text-sm font-medium text-base-content/70">GPS qurilmalar</h3>
                        <p class="text-xl font-bold text-base-content">
                            {% with count=0 %}
                                {% for item in bugalteriya_data %}
                                    {% with next_count=count|add:item.gps_data|length %}
                                    {% endwith %}
                                {% endfor %}
                                {{ next_count|default:0 }}
                            {% endwith %}
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Toast Container -->
    <div id="toast-container" class="fixed bottom-4 right-4 z-50"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Year select handling
    const yearSelect = document.getElementById('year-select');
    if (yearSelect) {
        yearSelect.addEventListener('change', function() {
            window.location.href = `?yil=${this.value}`;
        });
    }

    // Payment button handling
    document.querySelectorAll('.tolov-btn').forEach(button => {
        button.addEventListener('click', async function() {
            try {
                const isSuperuser = this.dataset.isSuperuser === 'true';
                const paymentType = this.dataset.type;
                const icon = this.querySelector('i');
                const currentClass = icon.className;
                
                // Determine new status based on current icon
                let newStatus, newIcon, newButtonClass;
                
                if (currentClass.includes('fa-plus-circle')) {
                    // From "To'lovni tasdiqlash" to "To'lanmagan"
                    newStatus = "To'lanmagan";
                    newIcon = "fa-times-circle";
                    newButtonClass = "btn-error text-white";
                } else if (currentClass.includes('fa-times-circle')) {
                    // From "To'lanmagan" to "To'langan"
                    newStatus = "To'langan";
                    newIcon = "fa-check-circle";
                    newButtonClass = "btn-success text-white";
                } else if (currentClass.includes('fa-check-circle')) {
                    // From "To'langan" to "Null"
                    newStatus = "Belgilanmagan";
                    newIcon = "fa-circle-notch";
                    newButtonClass = "btn-ghost";
                } else if (currentClass.includes('fa-circle-notch') && isSuperuser) {
                    // From "Null" to "To'lanmagan" (only for superuser)
                    newStatus = "To'lanmagan";
                    newIcon = "fa-times-circle";
                    newButtonClass = "btn-error text-white";
                } else {
                    return; // No change for other cases
                }

                // Show loading state
                this.classList.add('loading');
                
                // Get CSRF token from cookie
                const csrftoken = getCookie('csrftoken');
                console.log("CSRF Token:", csrftoken);
                
                // Prepare request data
                const requestData = {
                    tolov_id: this.dataset.tolovId || null,
                    sotish_id: this.dataset.sotishId,
                    gps_id: this.dataset.gpsId,
                    oy: this.dataset.oy,
                    yil: this.dataset.yil,
                    type: paymentType
                };
                
                console.log("Sending payment update:", requestData);
                
                const response = await fetch('{% url "update_bugalteriya" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify(requestData)
                });

                // Remove loading state
                this.classList.remove('loading');

                const data = await response.json();
                console.log("Server response:", data);
                
                if (!data.status) {
                    showToast(data.message || 'Xatolik yuz berdi', 'error');
                    return;
                }

                // Update payment ID if available
                if (data.tolov_id) {
                    this.dataset.tolovId = data.tolov_id;
                }

                // Update button appearance
                this.classList.remove('btn-primary', 'btn-success', 'btn-error', 'btn-ghost', 'text-white');
                this.classList.add(...newButtonClass.split(' '));
                
                // Update tooltip
                this.dataset.tip = newStatus;
                this.setAttribute('aria-label', newStatus);
                
                // Update icon
                icon.className = icon.className.replace(/(fa-plus-circle|fa-check-circle|fa-times-circle|fa-circle-notch)/, newIcon);
                
                // Show success toast
                showToast('To\'lov holati muvaffaqiyatli yangilandi', 'success');
                
                // Refresh the page after a short delay to show updated data
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
                
            } catch (error) {
                console.error('Xatolik:', error);
                showToast('Xatolik yuz berdi', 'error');
            }
        });
    });
});

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function showToast(message, type = 'info') {
    const toastContainer = document.getElementById('toast-container');
    if (!toastContainer) return;
    
    console.log(`Showing toast message: ${message} (${type})`);
    
    const toast = document.createElement('div');
    toast.className = `alert ${type === 'success' ? 'alert-success' : type === 'error' ? 'alert-error' : 'alert-info'} shadow-lg mb-2 opacity-0 transform translate-y-2 transition-all duration-300`;
    
    let icon = '';
    if (type === 'success') {
        icon = '<i class="fas fa-check-circle"></i>';
    } else if (type === 'error') {
        icon = '<i class="fas fa-exclamation-circle"></i>';
    } else {
        icon = '<i class="fas fa-info-circle"></i>';
    }
    
    toast.innerHTML = `
        <div class="flex items-center gap-2">
            ${icon}
            <span>${message}</span>
        </div>
    `;
    
    toastContainer.appendChild(toast);
    
    // Animate in
    setTimeout(() => {
        toast.classList.remove('opacity-0', 'translate-y-2');
    }, 10);
    
    // Animate out after delay
    setTimeout(() => {
        toast.classList.add('opacity-0', 'translate-y-2');
        setTimeout(() => {
            toast.remove();
        }, 300);
    }, 3000);
}
</script>
{% endblock %}