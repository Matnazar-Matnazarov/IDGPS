{% extends 'base.html'%}
{% load humanize %}
{% load static %}
{%block content%}
<div class="container mx-auto px-4">
    <div class="mt-6 flex justify-between items-center">
        <h1 class="text-2xl font-bold text-base-content flex items-center gap-2">
            <div class="bg-primary/10 p-2 rounded-full">
                <i class="fas fa-warehouse text-primary"></i>
            </div>
            <span class="animate-float">Sklad boshqaruvi</span>
        </h1>
        {% if request.path != '/sklad/add/' %}
        <a href="{% url 'skladadd' %}" class="btn btn-primary gap-2 btn-sm md:btn-md">
            <i class="fas fa-plus"></i>
            <span class="hidden sm:inline">GPS qo'shish</span>
            <span class="sm:hidden">Qo'shish</span>
        </a>
        {% else %}
        <a href="{% url 'sklad-list' %}" class="btn btn-ghost gap-2 btn-sm md:btn-md">
            <i class="fas fa-arrow-left"></i>
            <span class="hidden sm:inline">Orqaga</span>
        </a>
        {% endif %}
    </div>

    {% if request.path != '/sklad/add/' %}
    <!-- Sklad ro'yxati -->
    <div class="mt-8">
        <div class="card bg-base-100 shadow-xl overflow-hidden">
            <div class="card-body p-0">
                <!-- Filter and search tools -->
                <div class="bg-base-200/50 p-4 border-b border-base-300">
                    <div class="flex flex-col sm:flex-row gap-4 justify-between">
                        <div class="relative flex-grow max-w-md">
                            <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                <i class="fas fa-search text-gray-400"></i>
                            </div>
                            <input type="text" id="search-input" 
                                   class="input input-bordered w-full pl-10" 
                                   placeholder="GPS ID, sana yoki olingan odamni qidiring...">
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <div class="dropdown dropdown-end">
                                <div tabindex="0" role="button" class="btn btn-outline btn-sm" id="status-filter-button">
                                    <i class="fas fa-filter mr-2"></i> <span>Holat bo'yicha</span>
                                </div>
                                <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52" id="status-filter-dropdown">
                                    <li><a class="status-filter" data-filter="all">Barcha GPS</a></li>
                                    <li><a class="status-filter" data-filter="sold">Sotilgan</a></li>
                                    <li><a class="status-filter" data-filter="unsold">Sotilmagan</a></li>
                                </ul>
                            </div>
                            <div class="dropdown dropdown-end">
                                <div tabindex="0" role="button" class="btn btn-outline btn-sm" id="date-filter-button">
                                    <i class="fas fa-calendar-alt mr-2"></i> <span>Sana bo'yicha</span>
                                </div>
                                <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52" id="date-filter-dropdown">
                                    <li><a class="date-filter" data-filter="all">Barcha sanalar</a></li>
                                    <li><a class="date-filter" data-filter="today">Bugun</a></li>
                                    <li><a class="date-filter" data-filter="week">Shu hafta</a></li>
                                    <li><a class="date-filter" data-filter="month">Shu oy</a></li>
                                </ul>
                            </div>
                            <button class="btn btn-outline btn-sm btn-error" id="reset-filters" onclick="resetFilters()">
                                <i class="fas fa-undo mr-2"></i> <span>Tozalash</span>
                            </button>
                        </div>
                    </div>
            </div>

                <!-- Excel import (admin uchun) -->
                {% if request.user.is_superuser %}
                <div class="bg-base-200/30 p-4 border-b border-base-300">
                    <form method="POST" action="{% url 'gps-add-excel' %}" enctype="multipart/form-data" class="flex flex-wrap items-center gap-2">
                {% csrf_token %}
                        <div class="flex-grow flex items-center max-w-sm space-x-2">
                            <div class="relative flex-grow">
                                <input type="file" name="excel_file" accept=".xlsx, .xls" class="hidden" id="excel_file" onchange="updateFileName()">
                                <label for="excel_file" class="cursor-pointer flex items-center px-3 py-2 btn btn-outline btn-sm gap-2 w-full">
                                    <i class="fas fa-file-excel text-success"></i>
                                    <span id="file_name" class="truncate">Excel faylni tanlang</span>
                    </label>
                </div>
                            <button type="submit" class="btn btn-success btn-sm gap-2">
                                <i class="fas fa-upload"></i>
                                <span class="hidden sm:inline">Import</span>
                </button>
                        </div>
                        <a href="{% url 'gps-add-excel' %}?download_template=1" class="btn btn-ghost btn-sm text-info">
                            <i class="fas fa-download mr-1"></i> Shablon
                </a>
            </form>
    </div>
    {% endif %}

                <!-- Data table -->
                <div class="overflow-x-auto">
                    <table class="table table-zebra w-full">
                        <thead>
                            <tr>
                                <th class="bg-base-200">
                                    <div class="flex items-center gap-1">
                                        GPS ID
                                        <button onclick="setSortField('id')" class="btn btn-xs btn-ghost btn-circle">
                                            <i class="fas fa-sort text-xs"></i>
                                        </button>
                                    </div>
                                </th>
                                <th class="bg-base-200">
                                    <div class="flex items-center gap-1">
                                        Olingan odam
                                        <button onclick="setSortField('person')" class="btn btn-xs btn-ghost btn-circle">
                                            <i class="fas fa-sort text-xs"></i>
            </button>
    </div>
                                </th>
                                <th class="bg-base-200 hidden md:table-cell">Telefon raqam</th>
                    {% if request.user.is_superuser %}
                                <th class="bg-base-200 text-right">
                                    <div class="flex items-center justify-end gap-1">
                                        <button onclick="setSortField('price')" class="btn btn-xs btn-ghost btn-circle">
                                            <i class="fas fa-sort text-xs"></i>
                                        </button>
                                        Summa
                                    </div>
                                </th>
                    {%endif%}
                                <th class="bg-base-200">
                                    <div class="flex items-center gap-1">
                                        Sana
                                        <button onclick="setSortField('date')" class="btn btn-xs btn-ghost btn-circle">
                                            <i class="fas fa-sort text-xs"></i>
                                        </button>
                                    </div>
                                </th>
                                <th class="bg-base-200">Holat</th>
                                <th class="bg-base-200 w-24">Amallar</th>
                </tr>
            </thead>
            <tbody id="sklad-table-body">
                {% for item in skladlist %}
                            <tr class="hover transition-colors duration-200" 
                                data-id="{{ item.gps_id|lower }}" 
                                data-person="{{ item.olingan_odam|lower }}"
                                data-price="{{ item.summa_prixod }}"
                                data-date="{{ item.olingan_sana|date:'Y-m-d' }}"
                                data-status="{% if item.sotildi_sotilmadi %}sold{% else %}unsold{% endif %}">
                                <td class="font-medium">{{ item.gps_id }}</td>
                                <td>{{ item.olingan_odam }}</td>
                                <td class="hidden md:table-cell">
                                    <div class="flex items-center gap-1">
                                        <i class="fas fa-phone text-xs text-primary"></i>
                                        <a href="tel:{{ item.tel_raqam }}" class="hover:text-primary">{{ item.tel_raqam }}</a>
                                    </div>
                                </td>
                    {% if request.user.is_superuser %}
                                <td class="text-right font-medium">{{ item.summa_prixod|intcomma }}</td>
                    {%endif%}
                                <td><span class="badge badge-ghost">{{ item.olingan_sana|date:"d.m.Y" }}</span></td>
                                <td>
                        {% if item.sotildi_sotilmadi %}
                                        <div class="badge badge-success gap-1">
                                            <i class="fas fa-check-circle"></i>
                                            Sotilgan
                                        </div>
                        {% else %}
                                        <div class="badge badge-error gap-1">
                                            <i class="fas fa-times-circle"></i>
                                            Sotilmagan
                                        </div>
                        {% endif %}
                    </td>
                                <td>
                                    <div class="flex items-center space-x-2 justify-center">
                                        <a href="{% url 'sklad_update' item.id %}" class="btn btn-ghost btn-sm btn-circle text-info tooltip" data-tip="Tahrirlash">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <button onclick="confirmDelete('{{ item.id }}', '{{ item.gps_id }}')" class="btn btn-ghost btn-sm btn-circle text-error tooltip" data-tip="O'chirish">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="{% if request.user.is_superuser %}7{% else %}6{% endif %}" class="text-center py-8">
                                    <div class="flex flex-col items-center justify-center gap-2">
                                        <i class="fas fa-inbox text-4xl text-base-300"></i>
                                        <p class="text-base-content/70">Skladda GPS ma'lumotlari topilmadi</p>
                                        <a href="{% url 'skladadd' %}" class="btn btn-sm btn-primary mt-2">
                                            <i class="fas fa-plus mr-1"></i> GPS qo'shish
                                        </a>
                                    </div>
                                </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
                
                <!-- Status and pagination -->
                <div class="bg-base-200/50 p-4 border-t border-base-300">
                    <div class="flex flex-col sm:flex-row gap-4 justify-between items-center">
                        <div class="text-sm text-base-content/70">
                            <span id="visible-count">{{ skladlist|length }}</span> ta GPS ko'rsatilyapti (jami: {{ skladlist|length }})
                        </div>
                        
                        <!-- Summary cards -->
                        <div class="flex flex-wrap gap-4">
                            <div class="stats shadow bg-base-100">
                                <div class="stat p-2">
                                    <div class="stat-title text-xs">Jami GPSlar</div>
                                    <div class="stat-value text-primary text-xl">{{ skladlist|length }}</div>
                                </div>
                            </div>
                            <div class="stats shadow bg-base-100">
                                <div class="stat p-2">
                                    <div class="stat-title text-xs">Sotilmagan</div>
                                    <div class="stat-value text-error text-xl" id="unsold-count">
                                        {% with unsold_count=0 %}
                                            {% for item in skladlist %}
                                                {% if not item.sotildi_sotilmadi %}
                                                    {% with unsold_count=unsold_count|add:1 %}
                                                    {% endwith %}
                                                {% endif %}
                                            {% endfor %}
                                            {{ unsold_count }}
                                        {% endwith %}
                                    </div>
                                </div>
                            </div>
                            {% if request.user.is_superuser %}
                            <div class="stats shadow bg-base-100">
                                <div class="stat p-2">
                                    <div class="stat-title text-xs">Umumiy summa</div>
                                    <div class="stat-value text-secondary text-xl" id="total-amount">
                                        {% if skladlist %}
                                            {% with total=0 %}
                                                {% for item in skladlist %}
                                                    {% with total=total|add:item.summa_prixod %}
                                                    {% endwith %}
                                                {% endfor %}
                                                {{ total|intcomma }}
                                            {% endwith %}
                                        {% else %}
                                            0
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% elif request.path == '/sklad/add/' %}
    <!-- GPS qo'shish formi -->
    <div class="mt-8">
        <div class="card bg-base-100 shadow-xl max-w-2xl mx-auto">
            <div class="card-body">
                <h2 class="card-title text-xl font-semibold text-base-content mb-6 flex items-center gap-2">
                    <div class="p-2 rounded-full bg-primary/10">
                        <i class="fas fa-plus-circle text-primary"></i>
                    </div>
                    Yangi GPS qo'shish
                </h2>
                
                <form method="POST" class="grid gap-6" id="sklad-form">
                    {% csrf_token %}
                    
                    <!-- GPS ID lar -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-medium">GPS ID lar</span>
                            <span class="label-text-alt text-error">*</span>
                        </label>
                        
                        <div id="gps-container" class="space-y-3">
                            <div class="flex items-center gap-2">
                                <div class="input-group flex-grow">
                                    <span class="btn btn-square btn-ghost">
                                        <i class="fas fa-map-marker-alt text-gray-400"></i>
                                    </span>
                                    {{ form.gps_id }}
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-2">
                            <button type="button" onclick="addGpsField()" class="btn btn-outline btn-sm gap-2">
                                <i class="fas fa-plus-circle"></i>
                                GPS qo'shish
                            </button>
                        </div>
                    </div>
                    
                    <!-- Asosiy ma'lumotlar -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text font-medium">Olingan odam</span>
                                <span class="label-text-alt text-error">*</span>
                            </label>
                            <div class="input-group">
                                <span class="btn btn-square btn-ghost">
                                    <i class="fas fa-user text-gray-400"></i>
                                </span>
                {{ form.olingan_odam }}
                            </div>
            </div>

                        <div class="form-control">
                            <label class="label">
                                <span class="label-text font-medium">Telefon raqam</span>
                                <span class="label-text-alt text-error">*</span>
                            </label>
                            <div class="input-group">
                                <span class="btn btn-square btn-ghost">
                                    <i class="fas fa-phone text-gray-400"></i>
                                </span>
                {{ form.tel_raqam }}
                            </div>
            </div>

                        <div class="form-control">
                            <label class="label">
                                <span class="label-text font-medium">Summa (bitta GPS uchun)</span>
                                <span class="label-text-alt text-error">*</span>
                            </label>
                            <div class="input-group">
                                <span class="btn btn-square btn-ghost">
                                    <i class="fas fa-money-bill-wave text-gray-400"></i>
                                </span>
                                <!-- Custom input to replace Django's form field -->
                                <input type="text" 
                                       name="summa_prixod" 
                                       id="id_summa_prixod" 
                                       class="input input-bordered w-full" 
                                       placeholder="Summani kiriting" 
                                       required>
                            </div>
                            <label class="label">
                                <span class="label-text-alt text-base-content/60">So'm ko'rinishida, raqamlar bilan kiriting</span>
                            </label>
            </div>

                        <div class="form-control">
                            <label class="label">
                                <span class="label-text font-medium">Olingan sana</span>
                                <span class="label-text-alt text-error">*</span>
                            </label>
                            <div class="input-group">
                                <span class="btn btn-square btn-ghost">
                                    <i class="fas fa-calendar text-gray-400"></i>
                                </span>
                {{ form.olingan_sana }}
            </div>
                        </div>
    </div>

                    <div class="divider">Qo'shimcha ma'lumot</div>
                    
                    <div class="bg-base-200/50 p-4 rounded-lg">
                        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                            <div class="flex items-center gap-3">
                                <div class="avatar placeholder">
                                    <div class="bg-primary/10 text-primary rounded-full w-12">
                                        <i class="fas fa-info-circle text-xl"></i>
                                    </div>
                                </div>
                                <div>
                                    <h3 class="font-medium">GPS haqida</h3>
                                    <p class="text-sm text-base-content/70">Ma'lumotlarni to'liq to'ldiring</p>
                                </div>
                            </div>
                            <div class="stats shadow bg-base-100">
                                <div class="stat p-2">
                                    <div class="stat-title text-xs">GPS soni</div>
                                    <div class="stat-value text-primary text-lg" id="gps-count">1</div>
                                </div>
                            </div>
    </div>
  </div>

                    <div class="card-actions justify-end mt-4 gap-2">
                        <button type="button" class="btn btn-ghost gap-2" onclick="resetForm()">
                            <i class="fas fa-undo"></i>
                            <span>Bekor qilish</span>
                        </button>
                        <button type="submit" class="btn btn-primary gap-2">
                            <i class="fas fa-save"></i>
                            <span>Saqlash</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Delete Confirmation Modal -->
<div id="delete-modal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg flex items-center gap-2">
            <i class="fas fa-exclamation-triangle text-error"></i>
            GPS ma'lumotini o'chirish
        </h3>
        <p class="py-4">Siz <span id="delete-name" class="font-semibold"></span> GPS ma'lumotini o'chirishni xohlaysizmi?</p>
        <div class="alert alert-error mb-4">
            <i class="fas fa-info-circle"></i>
            <span>Bu amalni qaytarib bo'lmaydi!</span>
        </div>
        <div class="modal-action">
            <a href="#" id="confirm-delete-btn" class="btn btn-error gap-2">
                <i class="fas fa-trash"></i>
                O'chirish
            </a>
            <button class="btn" onclick="closeModal()">Bekor qilish</button>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</div>

<script src="{% static 'js/sklad.js' %}"></script>
{%endblock%}